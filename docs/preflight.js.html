<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: preflight.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: preflight.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as utils from "./utils/general.js";
import * as iutils from "./utils/inputs.js";
import * as f from "./abstract/file.js";

/**
 * Perform preflight validation of the annotations in the input matrices.
 *
 * This is usually done in regards to the consistency of gene annotations for multiple matrices.
 * If multiple matrices are present, an error is raised if any matrix does not contain gene annotations;
 * or there is no common species and feature type for annotations across all matrices;
 * or the intersection of genes is empty.
 *
 * @param {object} matrices - An object where each property is itself an object representing a single input matrix.
 * See the argument of the same name in {@linkcode runAnalysis} for more details.
 *
 * @return A promise that resolves to an object containing preflight check information:
 * - `annotations`: an object where each property corresponds to an input matrix in `matrices`.
 *   Each element is an array containing the names of the cell annotation fields in the corresponding matrix;
 *   or `null`, if that matrix does not contain any annotations.
 * - `features`: an object where each key is the name of a modality (e.g., `"RNA"`, `"ADT"`) and the property is another object.
 *   The latter contains:
 *   - `common`: an integer containing the number of common genes across all matrices.
 *      This may be `null` if `matrices` has only a single entry that lacks gene annotation.
 *   - `fields`: an object where each property corresponds to an input matrix in `matrices`.
 *      Each property is a string containing the name of the gene annotation field that was chosen for the intersection in the corresponding matrix.
 *      This may be `null` if `matrices` has only a single entry that lacks gene annotation.
 */
export async function validateAnnotations(matrices) {
    let mkeys = Object.keys(matrices);
    let multi = mkeys.length > 1;

    let promises = [];
    for (const key of mkeys) {
        let val = matrices[key];
        let namespace = iutils.chooseReader(val.format);
        promises.push(namespace.preflight(val));
    }
    let collected = await Promise.all(promises);

    let genes = {};
    let annotations = {};
    for (const [i, key] of Object.entries(mkeys)) {
        let stuff = collected[i];
        if (stuff.genes !== null) {
            genes[key] = stuff.genes;
        } else if (multi) {
            throw new Error("cannot find gene annotations for matrix '" + key + "'");
        }
        annotations[key] = stuff.annotations;
    }

    // Find the intersection of all modalities.
    let modalities = null;
    for (const [k, v] of Object.entries(genes)) {
        if (modalities == null) {
            modalities = new Set(Object.keys(v));
        } else {
            let alt = Object.keys(v).filter(x => modalities.has(x));
            modalities = new Set(alt);
        }
    }

    // For each modality, intersect the features.
    let feature_info = {};
    
    if (modalities !== null) {
        for (const m of modalities) {
            feature_info[m] = {};

            let genes2 = {};
            for (const [k, v] of Object.entries(genes)) {
                genes2[k] = v[m];
            }
            let results = iutils.commonFeatureTypes(genes2);
            if (results.best_type === null) {
                throw new Error("cannot find common feature types across all matrices");
            }
            feature_info[m].fields = results.best_fields;

            if (multi) {
                let intersection = null;
                for (const [k, v] of Object.entries(results.best_fields)) {
                    let curgenes = genes2[k][v];
                    if (intersection === null) {
                        intersection = curgenes;
                    } else {
                        let dset = new Set(curgenes);
                        intersection = intersection.filter(n => dset.has(n));
                    }
                }
                feature_info[m].common = intersection.length;
            } else {
                feature_info[m].common = Object.values(Object.values(genes2)[0])[0].length;
            }
        }
    } else {
        feature_info["RNA"] = { common: null, fields: null };
    }

    return { 
        annotations: annotations,
        features: feature_info
    };
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BatchCorrectionState.html">BatchCorrectionState</a></li><li><a href="CellFilteringState.html">CellFilteringState</a></li><li><a href="CellLabellingState.html">CellLabellingState</a></li><li><a href="ChooseClusteringState.html">ChooseClusteringState</a></li><li><a href="CombineEmbeddingsState.html">CombineEmbeddingsState</a></li><li><a href="CustomSelectionsState.html">CustomSelectionsState</a></li><li><a href="FeatureSelectionState.html">FeatureSelectionState</a></li><li><a href="InputsState.html">InputsState</a></li><li><a href="KmeansClusterState.html">KmeansClusterState</a></li><li><a href="MarkerDetectionState.html">MarkerDetectionState</a></li><li><a href="NeighborIndexState.html">NeighborIndexState</a></li><li><a href="NormalizationState.html">NormalizationState</a></li><li><a href="PcaState.html">PcaState</a></li><li><a href="QualityControlState.html">QualityControlState</a></li><li><a href="SnnGraphClusterState.html">SnnGraphClusterState</a></li><li><a href="TsneState.html">TsneState</a></li><li><a href="UmapState.html">UmapState</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-custom_readers.html">custom_readers</a></li></ul><h3>Global</h3><ul><li><a href="global.html#analysisDefaults">analysisDefaults</a></li><li><a href="global.html#availableReaders">availableReaders</a></li><li><a href="global.html#callScran">callScran</a></li><li><a href="global.html#configureApproximateNeighbors">configureApproximateNeighbors</a></li><li><a href="global.html#configureBatchCorrection">configureBatchCorrection</a></li><li><a href="global.html#createAnalysis">createAnalysis</a></li><li><a href="global.html#createKanaFile">createKanaFile</a></li><li><a href="global.html#freeAnalysis">freeAnalysis</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#loadAnalysis">loadAnalysis</a></li><li><a href="global.html#parseKanaFile">parseKanaFile</a></li><li><a href="global.html#promoteToNumber">promoteToNumber</a></li><li><a href="global.html#readLines">readLines</a></li><li><a href="global.html#readTable">readTable</a></li><li><a href="global.html#removeHDF5File">removeHDF5File</a></li><li><a href="global.html#runAnalysis">runAnalysis</a></li><li><a href="global.html#saveAnalysis">saveAnalysis</a></li><li><a href="global.html#setCellLabellingDownload">setCellLabellingDownload</a></li><li><a href="global.html#setCreateLink">setCreateLink</a></li><li><a href="global.html#setResolveLink">setResolveLink</a></li><li><a href="global.html#setVisualizationAnimate">setVisualizationAnimate</a></li><li><a href="global.html#terminate">terminate</a></li><li><a href="global.html#unpackText">unpackText</a></li><li><a href="global.html#validateAnnotations">validateAnnotations</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Sun Jun 26 2022 05:55:53 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
