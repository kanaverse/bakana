<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: preflight.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: preflight.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as utils from "./utils/general.js";
import * as iutils from "./utils/inputs.js";
import * as f from "./abstract/file.js";

/**
 * Perform preflight validation of the annotations in the input matrices.
 *
 * This is usually done in regards to the consistency of gene annotations for multiple matrices.
 * If multiple matrices are present, an error is raised if any matrix does not contain gene annotations;
 * or there is no common species and feature type for annotations across all matrices;
 * or the intersection of genes is empty.
 *
 * @param {object} matrices - An object where each property is itself an object representing a single input matrix.
 * See the argument of the same name in {@linkcode runAnalysis} for more details.
 *
 * @return An object containing preflight check information:
 * - `annotations`: an object where each property corresponds to an input matrix in `matrices`.
 *   Each element is an array containing the names of the cell annotation fields in the corresponding matrix;
 *   or `null`, if that matrix does not contain any annotations.
 *
 * If `matrices` has more than one matrix, the output will also contain:
 * - `common_genes`: an integer containing the number of common genes across all matrices.
 * - `best_gene_fields`: an object where each property corresponds to an input matrix in `matrices`.
 *   Each property is a string containing the name of the gene annotation field that was chosen for the intersection in the corresponding matrix.
 */
export function validateAnnotations(matrices) {
    let genes = {};
    let annotations = {};
    let entries = Object.entries(matrices);

    for (const [key, val] of entries) {
        let namespace = iutils.chooseReader(val.format);
        let stuff = namespace.preflight(val);

        if (stuff.genes !== null) {
            genes[key] = stuff.genes;
        } else if (entries.length > 1) {
            throw new Error("cannot find gene annotations for matrix '" + key + "'");
        }

        annotations[key] = stuff.annotations;
    }

    let output = { annotations: annotations };

    if (entries.length > 1) {
        let results = iutils.commonFeatureTypes(genes);
        if (results.best_type === null) {
            throw new Error("cannot find common feature types across all matrices");
        }
        output.best_gene_fields = results.best_fields;

        let intersection = null;
        for (const [k, v] of Object.entries(results.best_fields)) {
            let curgenes = genes[k][v];
            if (intersection === null) {
                intersection = curgenes;
            } else {
                let dset = new Set(curgenes);
                intersection = intersection.filter(n => dset.has(n));
            }
        }

        if (intersection.length === 0) {
            throw new Error("cannot find common genes across all matrices");
        }
        output.common_genes = intersection.length;
    }

    return output;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="cell_labelling.html">cell_labelling</a></li><li><a href="choose_clustering.html">choose_clustering</a></li><li><a href="custom_selections.html">custom_selections</a></li><li><a href="feature_selection.html">feature_selection</a></li><li><a href="inputs.html">inputs</a></li><li><a href="kmeans_cluster.html">kmeans_cluster</a></li><li><a href="marker_detection.html">marker_detection</a></li><li><a href="neighbor_index.html">neighbor_index</a></li><li><a href="normalization.html">normalization</a></li><li><a href="pca.html">pca</a></li><li><a href="quality_control.html">quality_control</a></li><li><a href="snn_graph_cluster.html">snn_graph_cluster</a></li><li><a href="tsne.html">tsne</a></li><li><a href="umap.html">umap</a></li></ul><h3>Global</h3><ul><li><a href="global.html#analysisDefaults">analysisDefaults</a></li><li><a href="global.html#availableReaders">availableReaders</a></li><li><a href="global.html#createAnalysis">createAnalysis</a></li><li><a href="global.html#createKanaFile">createKanaFile</a></li><li><a href="global.html#freeAnalysis">freeAnalysis</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#loadAnalysis">loadAnalysis</a></li><li><a href="global.html#parseKanaFile">parseKanaFile</a></li><li><a href="global.html#runAnalysis">runAnalysis</a></li><li><a href="global.html#saveAnalysis">saveAnalysis</a></li><li><a href="global.html#setCellLabellingDownload">setCellLabellingDownload</a></li><li><a href="global.html#setCreateLink">setCreateLink</a></li><li><a href="global.html#setResolveLink">setResolveLink</a></li><li><a href="global.html#setVisualizationAnimate">setVisualizationAnimate</a></li><li><a href="global.html#terminate">terminate</a></li><li><a href="global.html#validateAnnotations">validateAnnotations</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Thu Apr 07 2022 16:50:24 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
