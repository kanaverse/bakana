<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>analysis.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/LTLA/bakana" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="AbstractArtifactdbDataset.html">AbstractArtifactdbDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#options">options</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setAdtCountAssay">setAdtCountAssay</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setAdtExperiment">setAdtExperiment</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setCrisprCountAssay">setCrisprCountAssay</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setCrisprExperiment">setCrisprExperiment</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setRnaCountAssay">setRnaCountAssay</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#setRnaExperiment">setRnaExperiment</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbDataset.html#summary">summary</a></li></ul></li><li><a href="AbstractArtifactdbResult.html">AbstractArtifactdbResult</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AbstractArtifactdbResult.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbResult.html#load">load</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbResult.html#setIsPrimaryNormalized">setIsPrimaryNormalized</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbResult.html#setPrimaryAssay">setPrimaryAssay</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbResult.html#setReducedDimensionNames">setReducedDimensionNames</a></li><li data-type='method' style='display: none;'><a href="AbstractArtifactdbResult.html#summary">summary</a></li></ul></li><li><a href="AdtNormalizationState.html">AdtNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchNormalizedMatrix">fetchNormalizedMatrix</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="AdtNormalizationState.html#fetchSizeFactors">fetchSizeFactors</a></li></ul></li><li><a href="AdtPcaState.html">AdtPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtPcaState.html#fetchPCs">fetchPCs</a></li><li data-type='method' style='display: none;'><a href="AdtPcaState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="AdtQualityControlState.html">AdtQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchFilters">fetchFilters</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchMetrics">fetchMetrics</a></li><li data-type='method' style='display: none;'><a href="AdtQualityControlState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="BatchCorrectionState.html">BatchCorrectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchCorrected">fetchCorrected</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchNumberOfCells">fetchNumberOfCells</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchNumberOfDimensions">fetchNumberOfDimensions</a></li><li data-type='method' style='display: none;'><a href="BatchCorrectionState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CellFilteringState.html">CellFilteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellFilteringState.html#applyFilter">applyFilter</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredBlock">fetchFilteredBlock</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchFilteredMatrix">fetchFilteredMatrix</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CellFilteringState.html#undoFilter">undoFilter</a></li></ul></li><li><a href="CellLabellingState.html">CellLabellingState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CellLabellingState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#fetchNumberOfSharedFeatures">fetchNumberOfSharedFeatures</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#.flush">flush</a></li><li data-type='method' style='display: none;'><a href="CellLabellingState.html#.setDownload">setDownload</a></li></ul></li><li><a href="ChooseClusteringState.html">ChooseClusteringState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#fetchClusters">fetchClusters</a></li><li data-type='method' style='display: none;'><a href="ChooseClusteringState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CombineEmbeddingsState.html">CombineEmbeddingsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchCombined">fetchCombined</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchNumberOfCells">fetchNumberOfCells</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchNumberOfDimensions">fetchNumberOfDimensions</a></li><li data-type='method' style='display: none;'><a href="CombineEmbeddingsState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CrisprNormalizationState.html">CrisprNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#fetchNormalizedMatrix">fetchNormalizedMatrix</a></li><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CrisprNormalizationState.html#fetchSizeFactors">fetchSizeFactors</a></li></ul></li><li><a href="CrisprPcaState.html">CrisprPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrisprPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CrisprPcaState.html#fetchPCs">fetchPCs</a></li><li data-type='method' style='display: none;'><a href="CrisprPcaState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CrisprQualityControlState.html">CrisprQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchFilters">fetchFilters</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchMetrics">fetchMetrics</a></li><li data-type='method' style='display: none;'><a href="CrisprQualityControlState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="CustomSelectionsStandalone.html">CustomSelectionsStandalone</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#addSelection">addSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#fetchBlockLevels">fetchBlockLevels</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#fetchSelectionIndices">fetchSelectionIndices</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#fetchSelections">fetchSelections</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#free">free</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#removeSelection">removeSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsStandalone.html#setParameters">setParameters</a></li></ul></li><li><a href="CustomSelectionsState.html">CustomSelectionsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#addSelection">addSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelectionIndices">fetchSelectionIndices</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#fetchSelections">fetchSelections</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#free">free</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#removeSelection">removeSelection</a></li><li data-type='method' style='display: none;'><a href="CustomSelectionsState.html#.defaults">defaults</a></li></ul></li><li><a href="FeatureSelectionState.html">FeatureSelectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="FeatureSelectionState.html#fetchSortedResiduals">fetchSortedResiduals</a></li></ul></li><li><a href="FeatureSetEnrichmentStandalone.html">FeatureSetEnrichmentStandalone</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#computeEnrichment">computeEnrichment</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#computePerCellScores">computePerCellScores</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#fetchCollectionDetails">fetchCollectionDetails</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#fetchFeatureSetIndices">fetchFeatureSetIndices</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#fetchSetDetails">fetchSetDetails</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#fetchUniverseSize">fetchUniverseSize</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#free">free</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#ready">ready</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentStandalone.html#setParameters">setParameters</a></li></ul></li><li><a href="FeatureSetEnrichmentState.html">FeatureSetEnrichmentState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#computeEnrichment">computeEnrichment</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#computePerCellScores">computePerCellScores</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchCollectionDetails">fetchCollectionDetails</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchFeatureSetIndices">fetchFeatureSetIndices</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchSetDetails">fetchSetDetails</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#fetchUniverseSize">fetchUniverseSize</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#free">free</a></li><li data-type='method' style='display: none;'><a href="FeatureSetEnrichmentState.html#.defaults">defaults</a></li></ul></li><li><a href="H5adDataset.html">H5adDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="H5adDataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setCountMatrixName">setCountMatrixName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeAdtName">setFeatureTypeAdtName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeColumnName">setFeatureTypeColumnName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeCrisprName">setFeatureTypeCrisprName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setFeatureTypeRnaName">setFeatureTypeRnaName</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="H5adDataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="H5adResult.html">H5adResult</a><ul class='methods'><li data-type='method' style='display: none;'><a href="H5adResult.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#load">load</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setFeatureTypeColumnName">setFeatureTypeColumnName</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setIsPrimaryNormalized">setIsPrimaryNormalized</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setPrimaryMatrixName">setPrimaryMatrixName</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#setReducedDimensionNames">setReducedDimensionNames</a></li><li data-type='method' style='display: none;'><a href="H5adResult.html#summary">summary</a></li></ul></li><li><a href="InputsState.html">InputsState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="InputsState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#enableDatasetCache">enableDatasetCache</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchBlock">fetchBlock</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchBlockLevels">fetchBlockLevels</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchCellAnnotations">fetchCellAnnotations</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchCountMatrix">fetchCountMatrix</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchDirectSubset">fetchDirectSubset</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchFeatureAnnotations">fetchFeatureAnnotations</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#fetchRowIds">fetchRowIds</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#setDirectSubset">setDirectSubset</a></li><li data-type='method' style='display: none;'><a href="InputsState.html#undoSubset">undoSubset</a></li></ul></li><li><a href="KmeansClusterState.html">KmeansClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#fetchClusters">fetchClusters</a></li><li data-type='method' style='display: none;'><a href="KmeansClusterState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="MarkerDetectionStandalone.html">MarkerDetectionStandalone</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#computeAll">computeAll</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#fetchBlockLevels">fetchBlockLevels</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#fetchGroupLevels">fetchGroupLevels</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#free">free</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionStandalone.html#setParameters">setParameters</a></li></ul></li><li><a href="MarkerDetectionState.html">MarkerDetectionState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#computeVersus">computeVersus</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#fetchResults">fetchResults</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#free">free</a></li><li data-type='method' style='display: none;'><a href="MarkerDetectionState.html#.defaults">defaults</a></li></ul></li><li><a href="NeighborIndexState.html">NeighborIndexState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#fetchIndex">fetchIndex</a></li><li data-type='method' style='display: none;'><a href="NeighborIndexState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="RnaNormalizationState.html">RnaNormalizationState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#fetchNormalizedMatrix">fetchNormalizedMatrix</a></li><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="RnaNormalizationState.html#fetchSizeFactors">fetchSizeFactors</a></li></ul></li><li><a href="RnaPcaState.html">RnaPcaState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RnaPcaState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="RnaPcaState.html#fetchPCs">fetchPCs</a></li><li data-type='method' style='display: none;'><a href="RnaPcaState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="RnaQualityControlState.html">RnaQualityControlState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchDiscards">fetchDiscards</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchFilters">fetchFilters</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchMetrics">fetchMetrics</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#.flush">flush</a></li><li data-type='method' style='display: none;'><a href="RnaQualityControlState.html#.setDownload">setDownload</a></li></ul></li><li><a href="SimpleFile.html">SimpleFile</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SimpleFile.html#buffer">buffer</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#content">content</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#name">name</a></li><li data-type='method' style='display: none;'><a href="SimpleFile.html#size">size</a></li></ul></li><li><a href="SnnGraphClusterState.html">SnnGraphClusterState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#fetchClusters">fetchClusters</a></li><li data-type='method' style='display: none;'><a href="SnnGraphClusterState.html#fetchParameters">fetchParameters</a></li></ul></li><li><a href="SummarizedExperimentDataset.html">SummarizedExperimentDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setAdtCountAssay">setAdtCountAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setAdtExperiment">setAdtExperiment</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setCrisprCountAssay">setCrisprCountAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setCrisprExperiment">setCrisprExperiment</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setRnaCountAssay">setRnaCountAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#setRnaExperiment">setRnaExperiment</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentDataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="SummarizedExperimentResult.html">SummarizedExperimentResult</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#load">load</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#setIsPrimaryNormalized">setIsPrimaryNormalized</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#setPrimaryAssay">setPrimaryAssay</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#setReducedDimensionNames">setReducedDimensionNames</a></li><li data-type='method' style='display: none;'><a href="SummarizedExperimentResult.html#summary">summary</a></li></ul></li><li><a href="TenxHdf5Dataset.html">TenxHdf5Dataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setFeatureTypeAdtName">setFeatureTypeAdtName</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setFeatureTypeCrisprName">setFeatureTypeCrisprName</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setFeatureTypeRnaName">setFeatureTypeRnaName</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="TenxHdf5Dataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="TenxMatrixMarketDataset.html">TenxMatrixMarketDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setFeatureTypeAdtName">setFeatureTypeAdtName</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setFeatureTypeCrisprName">setFeatureTypeCrisprName</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setFeatureTypeRnaName">setFeatureTypeRnaName</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="TenxMatrixMarketDataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="TsneState.html">TsneState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TsneState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="TsneState.html#fetchResults">fetchResults</a></li></ul></li><li><a href="UmapState.html">UmapState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UmapState.html#animate">animate</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#compute">compute</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#fetchParameters">fetchParameters</a></li><li data-type='method' style='display: none;'><a href="UmapState.html#fetchResults">fetchResults</a></li></ul></li><li><a href="ZippedArtifactdbDataset.html">ZippedArtifactdbDataset</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#abbreviate">abbreviate</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#options">options</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#serialize">serialize</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setAdtCountAssay">setAdtCountAssay</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setAdtExperiment">setAdtExperiment</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setCrisprCountAssay">setCrisprCountAssay</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setCrisprExperiment">setCrisprExperiment</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setPrimaryAdtFeatureIdColumn">setPrimaryAdtFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setPrimaryCrisprFeatureIdColumn">setPrimaryCrisprFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setPrimaryRnaFeatureIdColumn">setPrimaryRnaFeatureIdColumn</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setRnaCountAssay">setRnaCountAssay</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#setRnaExperiment">setRnaExperiment</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#summary">summary</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbDataset.html#.unserialize">unserialize</a></li></ul></li><li><a href="ZippedArtifactdbResult.html">ZippedArtifactdbResult</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ZippedArtifactdbResult.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbResult.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbResult.html#setIsPrimaryNormalized">setIsPrimaryNormalized</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbResult.html#setPrimaryAssay">setPrimaryAssay</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbResult.html#setReducedDimensionNames">setReducedDimensionNames</a></li><li data-type='method' style='display: none;'><a href="ZippedArtifactdbResult.html#summary">summary</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-DataFrame.html">external:DataFrame</a></li><li><a href="external-ModelGeneVarResults.html">external:ModelGeneVarResults</a></li><li><a href="external-MultiMatrix.html">external:MultiMatrix</a></li><li><a href="external-PerCellAdtQcMetricsResults.html">external:PerCellAdtQcMetricsResults</a></li><li><a href="external-PerCellCrisprQcMetricsResults.html">external:PerCellCrisprQcMetricsResults</a></li><li><a href="external-PerCellRnaQcMetricsResults.html">external:PerCellRnaQcMetricsResults</a></li><li><a href="external-RunPCAResults.html">external:RunPCAResults</a></li><li><a href="external-ScoreMarkersResults.html">external:ScoreMarkersResults</a></li><li><a href="external-ScranMatrix.html">external:ScranMatrix</a></li><li><a href="external-SuggestAdtQcFiltersResults.html">external:SuggestAdtQcFiltersResults</a></li><li><a href="external-SuggestCrisprQcFiltersResults.html">external:SuggestCrisprQcFiltersResults</a></li><li><a href="external-SuggestRnaQcFiltersResults.html">external:SuggestRnaQcFiltersResults</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ArtifactdbProjectNavigator">ArtifactdbProjectNavigator</a></li><li><a href="global.html#Dataset">Dataset</a></li><li><a href="global.html#analysisDefaults">analysisDefaults</a></li><li><a href="global.html#availableReaders">availableReaders</a></li><li><a href="global.html#callScran">callScran</a></li><li><a href="global.html#configureApproximateNeighbors">configureApproximateNeighbors</a></li><li><a href="global.html#configureBatchCorrection">configureBatchCorrection</a></li><li><a href="global.html#createAnalysis">createAnalysis</a></li><li><a href="global.html#formatMarkerResults">formatMarkerResults</a></li><li><a href="global.html#freeAnalysis">freeAnalysis</a></li><li><a href="global.html#guessApproximateNeighborsConfig">guessApproximateNeighborsConfig</a></li><li><a href="global.html#guessBatchCorrectionConfig">guessBatchCorrectionConfig</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#loadAnalysis">loadAnalysis</a></li><li><a href="global.html#parseKanaFile">parseKanaFile</a></li><li><a href="global.html#promoteToNumber">promoteToNumber</a></li><li><a href="global.html#readLines2">readLines2</a></li><li><a href="global.html#readTable2">readTable2</a></li><li><a href="global.html#retrieveParameters">retrieveParameters</a></li><li><a href="global.html#runAnalysis">runAnalysis</a></li><li><a href="global.html#saveSingleCellExperiment">saveSingleCellExperiment</a></li><li><a href="global.html#serializeConfiguration">serializeConfiguration</a></li><li><a href="global.html#serializeDatasets">serializeDatasets</a></li><li><a href="global.html#setCreateLink">setCreateLink</a></li><li><a href="global.html#setResolveLink">setResolveLink</a></li><li><a href="global.html#setVisualizationAnimate">setVisualizationAnimate</a></li><li><a href="global.html#subsetInputs">subsetInputs</a></li><li><a href="global.html#summarizeArray">summarizeArray</a></li><li><a href="global.html#terminate">terminate</a></li><li><a href="global.html#unserializeConfiguration">unserializeConfiguration</a></li><li><a href="global.html#unserializeDatasets">unserializeDatasets</a></li><li><a href="global.html#zipFiles">zipFiles</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">analysis.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as scran from "scran.js";

import * as inputs from "./steps/inputs.js";

import * as qc from "./steps/rna_quality_control.js";
import * as qcadt from "./steps/adt_quality_control.js";
import * as qccrispr from "./steps/crispr_quality_control.js";
import * as filters from "./steps/cell_filtering.js";

import * as normalization from "./steps/rna_normalization.js";
import * as normadt from "./steps/adt_normalization.js";
import * as normcrispr from "./steps/crispr_normalization.js";

import * as variance from "./steps/feature_selection.js";

import * as pca from "./steps/rna_pca.js";
import * as pcaadt from "./steps/adt_pca.js";
import * as pcacrispr from "./steps/crispr_pca.js";
import * as combine from "./steps/combine_embeddings.js";
import * as correct from "./steps/batch_correction.js";

import * as index from "./steps/neighbor_index.js";
import * as cluster_choice from "./steps/choose_clustering.js";
import * as kmeans_cluster from "./steps/kmeans_cluster.js";
import * as snn_cluster from "./steps/snn_graph_cluster.js";

import * as tsne from "./steps/tsne.js";
import * as umap from "./steps/umap.js";

import * as cluster_markers from "./steps/marker_detection.js";
import * as label_cells from "./steps/cell_labelling.js";
import * as custom_markers from "./steps/custom_selections.js";

import * as feature_set_enrichment from "./steps/feature_set_enrichment.js";

import { FORMAT_VERSION } from "./abstract/utils/serialize.js";

export { setCreateLink, setResolveLink } from "./steps/inputs.js";
export { MarkerDetectionState } from "./steps/marker_detection.js";
export { CustomSelectionsState } from "./steps/custom_selections.js";

const step_inputs = inputs.step_name;
const step_qc = qc.step_name;
const step_qc_adt = qcadt.step_name;
const step_qc_crispr = qccrispr.step_name;
const step_filter = filters.step_name;
const step_norm = normalization.step_name;
const step_norm_adt = normadt.step_name;
const step_norm_crispr = normcrispr.step_name;
const step_feat = "feature_selection";
const step_pca = pca.step_name;
const step_pca_adt = pcaadt.step_name;
const step_pca_crispr = pcacrispr.step_name;
const step_combine = "combine_embeddings";
const step_correct = "batch_correction";
const step_neighbors = index.step_name;
const step_tsne = "tsne";
const step_umap = "umap";
const step_kmeans = "kmeans_cluster";
const step_snn = snn_cluster.step_name;
const step_choice = "choose_clustering";
const step_markers = cluster_markers.step_name;
const step_labels = "cell_labelling";
const step_custom = custom_markers.step_name;
const step_enrichment = feature_set_enrichment.step_name;

const load_flag = "_loaded";

/**
 * Create a new analysis state in preparation for calling {@linkcode runAnalysis}.
 * Multiple states can be created and used interchangeably within the same Javascript runtime.
 *
 * @return A promise that resolves to an object containing states for all analysis steps.
 * This object can be used as input into {@linkcode runAnalysis}.
 */
export async function createAnalysis() {
    return create_analysis(new inputs.InputsState);
}

function create_analysis(input_state) {
    let output = {};
    output[step_inputs] = input_state;

    output[step_qc] = new qc.RnaQualityControlState(output[step_inputs]);
    output[step_qc_adt] = new qcadt.AdtQualityControlState(output[step_inputs]);
    output[step_qc_crispr] = new qccrispr.CrisprQualityControlState(output[step_inputs]);

    let qc_states = { "RNA": output[step_qc], "ADT": output[step_qc_adt], "CRISPR": output[step_qc_crispr] }
    output[step_filter] = new filters.CellFilteringState(output[step_inputs], qc_states);

    output[step_norm] = new normalization.RnaNormalizationState(output[step_qc], output[step_filter]);
    output[step_norm_adt] = new normadt.AdtNormalizationState(output[step_qc_adt], output[step_filter]);
    output[step_norm_crispr] = new normcrispr.CrisprNormalizationState(output[step_qc_crispr], output[step_filter]);

    output[step_feat] = new variance.FeatureSelectionState(output[step_filter], output[step_norm]);

    output[step_pca] = new pca.RnaPcaState(output[step_filter], output[step_norm], output[step_feat]);
    output[step_pca_adt] = new pcaadt.AdtPcaState(output[step_filter], output[step_norm_adt]);
    output[step_pca_crispr] = new pcacrispr.CrisprPcaState(output[step_filter], output[step_norm_crispr]);

    let pca_states = { "RNA": output[step_pca], "ADT": output[step_pca_adt], "CRISPR": output[step_pca_crispr] }
    output[step_combine] = new combine.CombineEmbeddingsState(pca_states);
    output[step_correct] = new correct.BatchCorrectionState(output[step_filter], output[step_combine]);

    output[step_neighbors] = new index.NeighborIndexState(output[step_correct]);

    output[step_tsne] = new tsne.TsneState(output[step_neighbors]);
    output[step_umap] = new umap.UmapState(output[step_neighbors]);

    output[step_kmeans] = new kmeans_cluster.KmeansClusterState(output[step_correct]);
    output[step_snn] = new snn_cluster.SnnGraphClusterState(output[step_neighbors]);
    output[step_choice] = new cluster_choice.ChooseClusteringState(output[step_snn], output[step_kmeans]);

    let norm_states = { "RNA": output[step_norm], "ADT": output[step_norm_adt], "CRISPR": output[step_norm_crispr] };
    output[step_markers] = new cluster_markers.MarkerDetectionState(output[step_filter], norm_states, output[step_choice]);
    output[step_labels] = new label_cells.CellLabellingState(output[step_inputs], output[step_markers]);
    output[step_enrichment] = new feature_set_enrichment.FeatureSetEnrichmentState(output[step_inputs], output[step_filter], output[step_norm]);
    output[step_custom] = new custom_markers.CustomSelectionsState(output[step_filter], norm_states);

    return Promise.all([output[step_tsne].ready(), output[step_umap].ready()]).then(val => output);
}

/**
 * Free the contents of an analysis state.
 * This releases memory on the **scran.js** Wasm heap and terminates any workers associated with this analysis.
 *
 * @param state An existing analysis state, produced by {@linkcode createAnalysis} or {@linkcode loadAnalysis}.
 *
 * @return A promise that resolves to `null` when all states are freed.
 */
export function freeAnalysis(state) {
    let promises = [];
    for (const [k, v] of Object.entries(state)) {
        if (k == load_flag) {
            continue;
        }
        let p = v.free();
        if (p) { // not null, not undefined.
            promises.push(p); 
        }
    }
    return Promise.all(promises).then(x => null);
}

/**
 * Run a basic single-cell RNA-seq analysis with the specified files and parameters.
 * This will cache the results from each step so that, if the parameters change, only the affected steps will be rerun.
 *
 * @param {object} state - Object containing the analysis state, produced by {@linkcode createAnalysis} or {@linkcode loadAnalysis}.
 * @param {object} datasets - Object where each (arbitrarily named) property corresponds to an input dataset.
 * Each dataset should be a object that satisfies the {@linkplain Dataset} contract.
 *
 * Alternatively, `datasets` may be `null` if the input datasets were already loaded and cached in `state`.
 * This avoids the need to respecify the inputs after a previous call to {@linkcode runAnalysis} or from {@linkcode loadAnalysis}.
 * @param {object} params - An object containing parameters for all steps.
 * See {@linkcode analysisDefaults} for more details.
 * @param {object} [options] - Optional parameters.
 * @param {?function} [options.startFun=null] - Function that is called when each step is started.
 * This should accept a single argument - the name of the step.
 * The return value is ignored, but any promises will be awaited before the analysis proceeds to the next step.
 * If `null`, nothing is executed.
 * @param {?function} [options.finishFun=null] - Function that is called on successful execution of each step.
 * This should accept a single argument - the name of the step.
 * The return value is ignored, but any promises will be awaited before the analysis proceeds to the next step.
 * If `null`, nothing is executed.
 * 
 * @return A promise that resolves to `null` when all asynchronous analysis steps are complete.
 * The contents of `state` are modified by reference to reflect the latest state of the analysis with the supplied parameters.
 */
export async function runAnalysis(state, datasets, params, { startFun = null, finishFun = null } = {}) {
    let quickStart = async step => {
        if (startFun !== null) {
            await startFun(step);
        }
    }

    let quickFinish = async step => {
        if (finishFun !== null) {
            await finishFun(step);
        }
    }

    let promises = [];
    let deferredQuickFinish = (step, p) => {
        if (finishFun !== null) {
            if (state[step].changed) {
                p = p.then(out => finishFun(step, state[step]));
            } else {
                p = p.then(out => finishFun(step));
            }
        }
        promises.push(p);
    }

    /*** Loading ***/
    await quickStart(step_inputs);
    await state[step_inputs].compute(datasets, params[step_inputs]);
    await quickFinish(step_inputs);

    if (load_flag in state) {
        // Force recompute for all downstream steps. This avoids mixing results
        // from different versions if we're re-running off a reloaded state; if
        // some steps rerun, but others don't, we end up with a bastard state
        // from possibly different versions of this pipeline. It's also
        // difficult to guarantee that enough results were saved for use in
        // downstream steps, given that not everything is saved to file (and
        // indeed, the requirements of downstream steps may change in future
        // versions). So we just keep it simple and flush the whole state.
        state[step_inputs].changed = true;
        delete state[load_flag];
    }

    /*** Preprocessing steps ***/
    let basic_steps = [
        step_qc, step_qc_adt, step_qc_crispr,
        step_filter,
        step_norm, step_norm_adt, step_norm_crispr,
        step_feat,
        step_pca, step_pca_adt, step_pca_crispr,
        step_combine,
        step_correct,
        step_neighbors
    ];

    for (const step of basic_steps) {
        await quickStart(step);
        await state[step].compute(params[step]);
        await quickFinish(step);
    }

    /*** Visualization ***/
    for (const step of [ step_tsne, step_umap ]) {
        await quickStart(step);
        let p = state[step].compute(params[step]);
        deferredQuickFinish(step, p);
    }

    /*** Clustering ***/
    let method = params[step_choice]["method"];

    await quickStart(step_kmeans);
    state[step_kmeans].compute(method == "kmeans", params[step_kmeans]);
    await quickFinish(step_kmeans);

    await quickStart(step_snn);
    state[step_snn].compute(method == "snn_graph", params[step_snn]);
    await quickFinish(step_snn);

    await quickStart(step_choice);
    state[step_choice].compute(params[step_choice]);
    await quickFinish(step_choice);

    /*** Markers and labels ***/
    let remaining = [
        step_markers,
        step_labels,
        step_custom,
        step_enrichment
    ];

    for (const step of remaining) {
        await quickStart(step);
        await state[step].compute(params[step]);
        await quickFinish(step);
    }

    await Promise.all(promises);
    return null;
}

/**
 * Retrieve analysis parameters from a state object.
 *
 * @param {object} state - Object containing the analysis state, produced by {@linkcode createAnalysis} or {@linkcode loadAnalysis}.
 *
 * @return {object} Object containing the analysis parameters for each step, similar to that created by {@linkcode analysisDefaults}.
 */
export function retrieveParameters(state) {
    let params = {};
    for (const [k, v] of Object.entries(state)) {
        if (k == load_flag) {
            continue;
        }
        params[k] = v.fetchParameters();
    }
    return params;
}

/**
 * Create a new analysis state object consisting of a subset of cells from an existing analysis state.
 * This assumes that the existing state already contains loaded matrix data in its `inputs` property,
 * which allows us to create a cheap reference without reloading the data into memory.
 *
 * @param {object} state - State object such as that produced by {@linkcode createAnalysis} or {@linkcode linkAnalysis}.
 * This should already contain loaded data, e.g., after a run of {@linkcode runAnalysis}.
 * @param {TypedArray|Array} indices - Array containing the indices for the desired subset of cells.
 * This should be sorted and non-duplicate.
 * Any existing subset in `state` will be overridden by `indices`.
 * @param {object} [options] - Optional parameters.
 * @param {boolean} [options.copy=true] - Whether to make a copy of `indices` before storing it inside the returned state object.
 * If `false`, it is assumed that the caller makes no further use of the passed `indices`.
 * @param {boolean} [options.onOriginal=false] - Whether `indices` contains indices on the original dataset or on the dataset in `state`.
 * This distinction is only relevant if `state` itself contains an analysis of a subsetted dataset.
 * If `false`, the `indices` are assumed to refer to the columns of the already-subsetted dataset that exists in `state`;
 * if `true`, the `indices` are assumed to refer to the columns of the original dataset from which the subset in `state` was created.
 *
 * @return {object} A state object containing loaded matrix data in its `inputs` property.
 * Note that the other steps do not have any results, so this object should be passed through {@linkcode runAnalysis} before it can be used.
 */
export async function subsetInputs(state, indices, { copy = true, onOriginal = false } = {}) {
    return create_analysis(state.inputs.createDirectSubset(indices, { copy: copy, onOriginal: onOriginal }));
}

/****************************
 ********* LEGACY ***********
 ****************************/

/**
 * Load an analysis state from a HDF5 state file, usually excised from a `*.kana` file.
 *
 * @param {string} path - Path to the HDF5 file containing the analysis state.
 * On browsers, this should lie inside the virtual file system of the **scran.js** module.
 * @param {function} loadFun - Function to load each embedded data file.
 * This function is typically generated by {@linkcode parseKanaFile} and has the following characteristics:
 *
 * - It should accept two arguments, `offset` and `size`.
 *   `offset` is a number containing the offset to the start of any given file in the embedded file buffer.
 *   `size` is, of course, the size of the file.
 * - It should return any argument that can be used in the {@linkplain SimpleFile} constructor.
 *   This may be a Uint8Array, a File (on browsers) or a string containing a file path (on Node.js).
 *   Alternatively, the function may return a promise that resolves to the expected values.
 *
 * Note that this function is only used if the state file at `path` contains information for embedded files; 
 * otherwise, links are resolved using reader-specific functions (see {@linkcode setResolveLink} for the common use cases).
 * @param {object} [options] - Optional parameters.
 * @param {function} [options.finishFun] - Function that is called on after extracting results for each step.
 * This should accept two arguments - the name of the step and an object containing the results of that step.
 * The function may optionally be `async`.
 * If `null`, a no-op function is automatically created.
 *
 * @return An object containing the loaded analysis state.
 * This is conceptually equivalent to creating a state with {@linkcode createAnalysis} and running it through {@linkcode runAnalysis}.
 */
export async function loadAnalysis(path, loadFun, { finishFun = null } = {}) {
    let state = {};
    let handle = new scran.H5File(path);
    let quickFun = async step => {
        if (finishFun !== null) {
            await finishFun(step);
        }
    }

    /*** Loading ***/
    let permuters;
    {
        let out = await inputs.unserialize(handle, loadFun);
        state[step_inputs] = out.state;
        permuters = out.permuters;
        await quickFun(step_inputs);
    }

    /*** Quality control ***/
    {
        state[step_qc] = qc.unserialize(handle, state[step_inputs]);
        await quickFun(step_qc);
    }

    {
        state[step_qc_adt] = qcadt.unserialize(handle, state[step_inputs]);
        await quickFun(step_qc_adt);
    }

    {
        state[step_qc_crispr] = qccrispr.unserialize(handle, state[step_inputs]);
        await quickFun(step_qc_crispr);
    }

    {
        let qc_states = { RNA: state[step_qc], ADT: state[step_qc_adt], CRISPR: state[step_qc_crispr] };
        state[step_filter] = filters.unserialize(handle, state[step_inputs], qc_states);
        await quickFun(step_filter);
    }

    /*** Normalization ***/
    {
        state[step_norm] = normalization.unserialize(handle, state[step_qc], state[step_filter]);
        await quickFun(step_norm);
    }

    {
        state[step_norm_adt] = normadt.unserialize(handle, state[step_qc_adt], state[step_filter]);
        await quickFun(step_norm_adt);
    }

    {
        state[step_norm_crispr] = normcrispr.unserialize(handle, state[step_qc_crispr], state[step_filter]);
        await quickFun(step_norm_crispr);
    }

    /*** Feature selection ***/
    {
        state[step_feat] = variance.unserialize(handle, permuters["RNA"], state[step_filter], state[step_norm]);
        await quickFun(step_feat);
    }

    /*** Dimensionality reduction ***/
    {
        state[step_pca] = pca.unserialize(handle, state[step_filter], state[step_norm], state[step_feat]);
        await quickFun(step_pca);
    }

    {
        state[step_pca_adt] = pcaadt.unserialize(handle, state[step_filter], state[step_norm_adt]);
        await quickFun(step_pca_adt);
    }

    {
        state[step_pca_crispr] = pcacrispr.unserialize(handle, state[step_filter], state[step_norm_crispr]);
        await quickFun(step_pca_crispr);
    }

    {
        let pca_states = { RNA: state[step_pca], ADT: state[step_pca_adt], CRISPR: state[step_pca_crispr] };
        state[step_combine] = combine.unserialize(handle, pca_states);
        await quickFun(step_combine);
    }

    {
        state[step_correct] = correct.unserialize(handle, state[step_filter], state[step_combine]);
        await quickFun(step_correct);
    }

    /*** Nearest neighbors ***/
    {
        state[step_neighbors] = index.unserialize(handle, state[step_correct]);
        await quickFun(step_neighbors);
    }

    /*** Visualization ***/
    {
        state[step_tsne] = await tsne.unserialize(handle, state[step_neighbors]);
        await quickFun(step_tsne);
    }

    {
        state[step_umap] = await umap.unserialize(handle, state[step_neighbors]);
        await quickFun(step_umap);
    }

    /*** Clustering ***/
    {
        state[step_kmeans] = kmeans_cluster.unserialize(handle, state[step_correct]);
        await quickFun(step_kmeans);
    }

    {
        state[step_snn] = snn_cluster.unserialize(handle, state[step_neighbors]);
        await quickFun(step_snn);
    }

    {
        state[step_choice] = cluster_choice.unserialize(handle, state[step_snn], state[step_kmeans]);
        await quickFun(step_choice);
    }

    /*** Markers and labels ***/
    let norm_states = { "RNA": state[step_norm], "ADT": state[step_norm_adt], "CRISPR": state[step_norm_crispr] };
    {
        state[step_markers] = cluster_markers.unserialize(handle, permuters, state[step_filter], norm_states, state[step_choice]);
        await quickFun(step_markers);
    }

    {
        state[step_labels] = label_cells.unserialize(handle, state[step_inputs], state[step_markers]);
        await quickFun(step_labels);
    }

    {
        state[step_enrichment] = feature_set_enrichment.unserialize(handle, state[step_inputs], state[step_filter], state[step_norm]);
    }

    {
        state[step_custom] = custom_markers.unserialize(handle, permuters, state[step_filter], norm_states);
        await quickFun(step_custom);
    }

    // Adding a tripwire for runAnalysis.
    state[load_flag] = true;

    return state;
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Tue Mar 21 2023 06:30:59 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
